---
title: Ubuntu安装SqlServer
date: 2020-05-22
tags:
  - 学习，编程
categories:
  - Notes
---

## 安装 Sql Server 并在 Ubuntu 上创建数据库

> 参考文档：[官方文档](https://docs.microsoft.com/zh-cn/sql/linux/quickstart-install-connect-ubuntu?view=sql-server-ver15)
>
> 修改时间：2020 年 5 月 22 日 00 点 31 分

### :ballot_box_with_check: **先决条件**

> :heavy_exclamation_mark: ​ 不支持将适用于 Windows 10 的 *Linux 的 Windows 子系统*作为安装目标。

---

### :ballot_box_with_check: **安装 SQL Server**

> :pushpin: 以下用于 SQL Server 2019 的命令指向 Ubuntu 18.04 存储库。 如果使用的是 Ubuntu 16.04，请将以下路径更改为 `/ubuntu/16.04/` 而不是 `/ubuntu/18.04/`。

要在 Ubuntu 上配置 SQL Server，请在终端中运行以下命令以安装 mssql-server 包 。

1. 导入公共存储 GPG 密钥：

   ```bash
   wget -qO- https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
   ```

2. 为 SQL Server 2019 注册 Microsoft SQL Server Ubuntu 存储库：

   ```bash
   sudo add-apt-repository "$(wget -qO- https://packages.microsoft.com/config/ubuntu/18.04/mssql-server-2019.list)"
   ```

3. 运行以下命令以安装 SQL Server：

   ```bash
   sudo apt-get update
   sudo apt-get install -y mssql-server
   ```

4. 包安装完成后，运行 **mssql-conf setup**，按照提示设置 SA 密码并选择版本。

   ```bash
   sudo /opt/mssql/bin/mssql-conf setup
   ```

   > :triangular_flag_on_post: 请确保为 SA 帐户指定强密码（最少 8 个字符，包括大写和小写字母、十进制数字和/或非字母数字符号）。

5. 完成配置后，验证服务是否正在运行：

   ```bash
   systemctl status mssql-server --no-pager
   ```

6. 如果计划远程连接，可能还需要在防火墙上打开 SQL Server TCP 端口（默认值为 1433）

---

### :ballot_box_with_check: **安装 SQL Server 命令行工具**

> :triangular_flag_on_post: 若要创建数据库，则需要使用可在 SQL Server 上运行 Transact-SQL 语句的工具进行连接。 以下步骤将安装 SQL Server 命令行工具：[sqlcmd](https://docs.microsoft.com/zh-cn/sql/tools/sqlcmd-utility?view=sql-server-ver15) 和 [bcp](https://docs.microsoft.com/zh-cn/sql/tools/bcp-utility?view=sql-server-ver15)。

通过以下步骤在 Ubuntu 上安装*mssql-tools*

1. 导入公共存储库 GPG 密钥。

   ```bash
   curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
   ```

2. 注册 Microsoft Ubuntu 存储库。

   ```bash
   curl https://packages.microsoft.com/config/ubuntu/18.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
   ```

3. 更新源列表，并使用 unixODBC 开发人员包运行安装命令。 有关详细信息，请参阅[安装 Microsoft ODBC Driver for SQL Server (Linux)](https://docs.microsoft.com/zh-cn/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server?view=sql-server-ver15)。

   ```bash
   sudo apt-get update
   sudo apt-get install mssql-tools unixodbc-dev
   ```

   > :pushpin: 若要将 mssql-tools 更新至最新版本，请运行以下命令 ：
   >
   > ```bash
   > sudo apt-get update
   > sudo apt-get install mssql-tools
   > ```

4. **可选**：向 bash shell 中的 PATH 环境变量添加`/opt/mssql-tools/bin/`。

   要使 sqlcmd/bcp 能从登陆会话的 bash shell 进行访问，请使用下列命令修改 ~/.bash_profile 文件中的 PATH ：

   ```bath
   echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bash_profile
   ```

   要使 sqlcmd/bcp 能从交互式/非登录会话的 bash shell 进行访问，请使用下列命令修改 ~/.bashrc 文件中的 PATH ：

   ```bash
   echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
   source ~/.bashrc
   ```

---

### :ballot_box_with_check: **本地连接**

> :triangular_flag_on_post: 以下步骤使用 sqlcmd 本地连接到新的 SQL Server 实例。

1. 使用 SQL Server 名称 (-S)，用户名 (-U) 和密码 (-P) 的参数运行 sqlcmd 。 在本教程中，用户进行本地连接，因此服务器名称为 `localhost`。 用户名为 `SA`，密码是在安装过程中为 SA 帐户提供的密码。

   ```bash
   sqlcmd -S localhost -U SA -P '<YourPassword>'
   ```

   > :pushpin: 可以在命令行上省略密码，以收到密码输入提示。

   > :pushpin: 如果以后决定进行远程连接，请指定 -S 参数的计算机名称或 IP 地址，并确保防火墙上的端口 1433 已打开。

2. 如果成功，应会显示 sqlcmd 命令提示符：`1>`。
3. 如果连接失败，先尝试诊断错误消息中所述的问题。 然后查看[连接故障排除建议](https://docs.microsoft.com/zh-cn/sql/linux/sql-server-linux-troubleshooting-guide?view=sql-server-ver15#connection)。

---

### :ballot_box_with_check: **创建和查询数据**

> :triangular_flag_on_post: 下面各部分将逐步介绍如何使用 sqlcmd 新建数据库、添加数据并运行简单查询。

#### **新建数据库**

_以下步骤创建一个名为 `TestDB` 的新数据库。_

1. 在 sqlcmd 命令提示符中，粘贴以下 Transact-SQL 命令以创建测试数据库：

   ```sql
   CREATE DATABASE TestDB
   ```

2. 在下一行中，编写一个查询以返回服务器上所有数据库的名称：

   ```sql
   SELECT Name from sys.Databases
   ```

3. 前两个命令没有立即执行。 必须在新行中键入 `GO` 才能执行以前的命令：

   ```sql
   GO
   ```

> :pushpin: 若要详细了解如何编写 Transact-SQL 语句和查询，请参阅[教程：编写 Transact-SQL 语句](https://docs.microsoft.com/zh-cn/sql/t-sql/tutorial-writing-transact-sql-statements?view=sql-server-ver15)。

#### **插入数据**

_接下来创建一个新表 `Inventory`，然后插入两个新行。_

1. 在 sqlcmd 命令提示符中，将上下文切换到新的 `TestDB` 数据库：

   ```sql
   USE TestDB
   ```

2. 创建名为 `Inventory` 的新表：

   ```sql
   CREATE TABLE Inventory (id INT, name NVARCHAR(50), quantity INT)
   ```

3. 将数据插入新表：

   ```sql
   INSERT INTO Inventory VALUES (1, 'banana', 150); INSERT INTO Inventory VALUES (2, 'orange', 154);
   ```

4. 要执行上述命令的类型 `GO`：

   ```sql
   GO
   ```

#### **选择数据**

_现在，运行查询以从 `Inventory` 表返回数据。_

1. 通过 sqlcmd 命令提示符输入查询，以返回 `Inventory` 表中数量大于 152 的行：

   ```sql
   SELECT * FROM Inventory WHERE quantity > 152;
   ```

2. 执行此命令：

   ```sql
   GO
   ```

#### **退出 sqlcmd 命令提示符**

_要结束 sqlcmd 会话，请键入 `QUIT`：_

```sql
QUIT
```

---

### :star: **阿里云服务器 1433 端口未打开处理**

> 参考文档：[链接](https://blog.csdn.net/zhangjun965/article/details/79286363)
>
> 通过 telnet 命令发现 1433 端口未启用

_telnet 测试端口命令： telnet IP 端口_

**解决方法：**

登录【阿里云管理控制台】，左侧菜单依次点：
云计算基础服务 -> 云服务器 ECS -> 网络和安全 -> 安全组 -> 在安全组列表中选择默认安全组最右边的‘配置规则’
-> tab 页签选'入方向' -> 点右上角的‘添加安全组规则’
-> 规则方向：入方向 -> 授权策略：允许 -> 协议类型：MS SQL(1433) -> 授权对象：0.0.0.0/0 -> 确定

![](https://gitee.com/walktome/PicGoImages/raw/master/image-20200522011427429.png)

![](https://gitee.com/walktome/PicGoImages/raw/master/image-20200522011606491.png)

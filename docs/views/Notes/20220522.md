---
title: Ubuntu安装SqlServer
date: 2020-05-22
tags:
  - 学习，编程
categories:
  - Notes
---

## 安装 Sql Server 并在 Ubuntu 上创建数据库

> 参考文档：[官方文档](https://docs.microsoft.com/zh-cn/sql/linux/quickstart-install-connect-ubuntu?view=sql-server-ver15)
>
> 修改时间：2020 年 5 月 22 日 00 点 31 分

### :ballot_box_with_check: **先决条件**

> :heavy_exclamation_mark: ​ 不支持将适用于 Windows 10 的 *Linux 的 Windows 子系统*作为安装目标。

---

### :ballot_box_with_check: **安装 SQL Server**

> :pushpin: 以下用于 SQL Server 2019 的命令指向 Ubuntu 18.04 存储库。 如果使用的是 Ubuntu 16.04，请将以下路径更改为 `/ubuntu/16.04/` 而不是 `/ubuntu/18.04/`。

要在 Ubuntu 上配置 SQL Server，请在终端中运行以下命令以安装 mssql-server 包 。

1. 导入公共存储 GPG 密钥：

   ```bash
   wget -qO- https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
   ```

2. 为 SQL Server 2019 注册 Microsoft SQL Server Ubuntu 存储库：

   ```bash
   sudo add-apt-repository "$(wget -qO- https://packages.microsoft.com/config/ubuntu/18.04/mssql-server-2019.list)"
   ```

3. 运行以下命令以安装 SQL Server：

   ```bash
   sudo apt-get update
   sudo apt-get install -y mssql-server
   ```

4. 包安装完成后，运行 **mssql-conf setup**，按照提示设置 SA 密码并选择版本。

   ```bash
   sudo /opt/mssql/bin/mssql-conf setup
   ```

   > :triangular_flag_on_post: 请确保为 SA 帐户指定强密码（最少 8 个字符，包括大写和小写字母、十进制数字和/或非字母数字符号）。

5. 完成配置后，验证服务是否正在运行：

   ```bash
   systemctl status mssql-server --no-pager
   ```

6. 如果计划远程连接，可能还需要在防火墙上打开 SQL Server TCP 端口（默认值为 1433）

---

### :ballot_box_with_check: **安装 SQL Server 命令行工具**

> :triangular_flag_on_post: 若要创建数据库，则需要使用可在 SQL Server 上运行 Transact-SQL 语句的工具进行连接。 以下步骤将安装 SQL Server 命令行工具：[sqlcmd](https://docs.microsoft.com/zh-cn/sql/tools/sqlcmd-utility?view=sql-server-ver15) 和 [bcp](https://docs.microsoft.com/zh-cn/sql/tools/bcp-utility?view=sql-server-ver15)。

通过以下步骤在 Ubuntu 上安装*mssql-tools*

1. 导入公共存储库 GPG 密钥。

   ```bash
   curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
   ```

2. 注册 Microsoft Ubuntu 存储库。

   ```bash
   curl https://packages.microsoft.com/config/ubuntu/18.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
   ```

3. 更新源列表，并使用 unixODBC 开发人员包运行安装命令。 有关详细信息，请参阅[安装 Microsoft ODBC Driver for SQL Server (Linux)](https://docs.microsoft.com/zh-cn/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server?view=sql-server-ver15)。

   ```bash
   sudo apt-get update
   sudo apt-get install mssql-tools unixodbc-dev
   ```

   > :pushpin: 若要将 mssql-tools 更新至最新版本，请运行以下命令 ：
   >
   > ```bash
   > sudo apt-get update
   > sudo apt-get install mssql-tools
   > ```

4. **可选**：向 bash shell 中的 PATH 环境变量添加`/opt/mssql-tools/bin/`。

   要使 sqlcmd/bcp 能从登陆会话的 bash shell 进行访问，请使用下列命令修改 ~/.bash_profile 文件中的 PATH ：

   ```bath
   echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bash_profile
   ```

   要使 sqlcmd/bcp 能从交互式/非登录会话的 bash shell 进行访问，请使用下列命令修改 ~/.bashrc 文件中的 PATH ：

   ```bash
   echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
   source ~/.bashrc
   ```

---

### :ballot_box_with_check: **本地连接**

> :triangular_flag_on_post: 以下步骤使用 sqlcmd 本地连接到新的 SQL Server 实例。

1. 使用 SQL Server 名称 (-S)，用户名 (-U) 和密码 (-P) 的参数运行 sqlcmd 。 在本教程中，用户进行本地连接，因此服务器名称为 `localhost`。 用户名为 `SA`，密码是在安装过程中为 SA 帐户提供的密码。

   ```bash
   sqlcmd -S localhost -U SA -P '<YourPassword>'
   ```

   > :pushpin: 可以在命令行上省略密码，以收到密码输入提示。

   > :pushpin: 如果以后决定进行远程连接，请指定 -S 参数的计算机名称或 IP 地址，并确保防火墙上的端口 1433 已打开。

2. 如果成功，应会显示 sqlcmd 命令提示符：`1>`。
3. 如果连接失败，先尝试诊断错误消息中所述的问题。 然后查看[连接故障排除建议](https://docs.microsoft.com/zh-cn/sql/linux/sql-server-linux-troubleshooting-guide?view=sql-server-ver15#connection)。

---

### :ballot_box_with_check: **创建和查询数据**

> :triangular_flag_on_post: 下面各部分将逐步介绍如何使用 sqlcmd 新建数据库、添加数据并运行简单查询。

#### **新建数据库**

_以下步骤创建一个名为 `TestDB` 的新数据库。_

1. 在 sqlcmd 命令提示符中，粘贴以下 Transact-SQL 命令以创建测试数据库：

   ```sql
   CREATE DATABASE TestDB
   ```

2. 在下一行中，编写一个查询以返回服务器上所有数据库的名称：

   ```sql
   SELECT Name from sys.Databases
   ```

3. 前两个命令没有立即执行。 必须在新行中键入 `GO` 才能执行以前的命令：

   ```sql
   GO
   ```

> :pushpin: 若要详细了解如何编写 Transact-SQL 语句和查询，请参阅[教程：编写 Transact-SQL 语句](https://docs.microsoft.com/zh-cn/sql/t-sql/tutorial-writing-transact-sql-statements?view=sql-server-ver15)。

#### **插入数据**

_接下来创建一个新表 `Inventory`，然后插入两个新行。_

1. 在 sqlcmd 命令提示符中，将上下文切换到新的 `TestDB` 数据库：

   ```sql
   USE TestDB
   ```

2. 创建名为 `Inventory` 的新表：

   ```sql
   CREATE TABLE Inventory (id INT, name NVARCHAR(50), quantity INT)
   ```

3. 将数据插入新表：

   ```sql
   INSERT INTO Inventory VALUES (1, 'banana', 150); INSERT INTO Inventory VALUES (2, 'orange', 154);
   ```

4. 要执行上述命令的类型 `GO`：

   ```sql
   GO
   ```

#### **选择数据**

_现在，运行查询以从 `Inventory` 表返回数据。_

1. 通过 sqlcmd 命令提示符输入查询，以返回 `Inventory` 表中数量大于 152 的行：

   ```sql
   SELECT * FROM Inventory WHERE quantity > 152;
   ```

2. 执行此命令：

   ```sql
   GO
   ```

#### **退出 sqlcmd 命令提示符**

_要结束 sqlcmd 会话，请键入 `QUIT`：_

```sql
QUIT
```

---

### :star: **阿里云服务器 1433 端口未打开处理**

> 参考文档：[链接](https://blog.csdn.net/zhangjun965/article/details/79286363)
>
> 通过 telnet 命令发现 1433 端口未启用

_telnet 测试端口命令： telnet IP 端口_

**解决方法：**

登录【阿里云管理控制台】，左侧菜单依次点：
云计算基础服务 -> 云服务器 ECS -> 网络和安全 -> 安全组 -> 在安全组列表中选择默认安全组最右边的‘配置规则’
-> tab 页签选'入方向' -> 点右上角的‘添加安全组规则’
-> 规则方向：入方向 -> 授权策略：允许 -> 协议类型：MS SQL(1433) -> 授权对象：0.0.0.0/0 -> 确定

![](https://gitee.com/walktome/PicGoImages/raw/master/image-20200522011427429.png)

![](https://gitee.com/walktome/PicGoImages/raw/master/image-20200522011606491.png)

---

### :ballot_box_with_check: **使用 VSCode 跨平台连接 SQL Server**

> 参考文档：[官方文档](https://docs.microsoft.com/zh-cn/sql/visual-studio-code/sql-server-develop-use-vscode?view=sql-server-ver15)
>
> 修改时间：2020 年 5 月 22 日 10 点 54 分
>
> 适用于： ![是](https://docs.microsoft.com/zh-cn/sql/includes/media/yes-icon.png?view=sql-server-ver15)SQL Server（仅限 Linux）

- #### **安装 mssql 扩展**

  1. 在 Visual Studio Code 中，选择“查看” > “命令面板”，或按“Ctrl”+“Shift”+“P”，或按“F1”打开“命令面板”。

  2. 在命令面板中，从下拉列表中选择“扩展：安装扩展”。

  3. 在“扩展”窗格中，键入“mssql”。

  4. 选择“SQL Server (mssql)”扩展，然后选择“安装”。

     ![安装 mssql 扩展](https://docs.microsoft.com/zh-cn/sql/visual-studio-code/media/sql-server-develop-use-vscode/vscode-extension.png?view=sql-server-ver15)

  5. 安装完成后，选择“重新加载”以启用扩展。

- #### **创建或打开 SQL 文件**

  1. 选择“文件” > “新建文件”或按“Ctrl”+“N”。 默认情况下，Visual Studio Code 将打开一个新的“纯文本”文件。
  2. 在下方状态栏上选择“纯文本”，或按“Ctrl”+“K” > “M”，然后从“语言”下拉列表中选择“SQL”。

  ​ ![SQL 语言模式](https://docs.microsoft.com/zh-cn/sql/visual-studio-code/media/sql-server-develop-use-vscode/vscode-language-mode.png?view=sql-server-ver15)

  > :pushpin: 如果打开一个文件扩展名为 .sql 的现有文件，语言模式会自动设置为 SQL。

- #### **连接到 SQL Server**

  1. 按“Ctrl”+“Shift”+“P”或“F1”打开“命令面板”。

  2. 键入 sql 以显示 mssql 命令，或键入 sqlcon，然后从下拉列表中选择“MS SQL：连接”。

     ![mssql 命令](https://docs.microsoft.com/zh-cn/sql/visual-studio-code/media/sql-server-develop-use-vscode/vscode-commands.png?view=sql-server-ver15)

     > :pushpin: 代码编辑器中的焦点须位于 SQL 文件（例如创建的空 SQL 文件），才能执行 mssql 命令。

  3. 选择“MS SQL：管理连接配置文件”命令。

  4. 然后选择“创建”为 SQL Server 创建新的连接配置文件。

  5. 按照提示为新连接配置文件指定属性。 指定每个值后，按“Enter”继续。

     | 连接属性                        | 说明                                                                                                                                                                                                                                                                                                                                                              |
     | :------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
     | **服务器名称或 ADO 连接字符串** | 指定 SQL Server 实例名称。 使用 localhost 连接到本地计算机上的 SQL Server 实例。 如果要连接到远程 SQL Server，请输入目标 SQL Server 的名称，或它的 IP 地址。 若要连接到 SQL Server 容器，请指定容器主机的 IP 地址。 如果需要指定端口，请使用逗号将其与名称分开。 例如，对于侦听端口 1401 的服务器，请输入 `,1401`。 或者，可以在此处输入数据库的 ADO 连接字符串。 |
     | “数据库名称”（可选）            | 要使用的数据库。 若要连接到默认数据库，请不要在此处指定数据库名称。                                                                                                                                                                                                                                                                                               |
     | **身份验证类型**                | 选择“集成”或“SQL 登录”。                                                                                                                                                                                                                                                                                                                                          |
     | **用户名**                      | 如果选择了“SQL 登录”，则输入拥有访问服务器上数据库权限的用户名。                                                                                                                                                                                                                                                                                                  |
     | **密码**                        | 输入指定用户的密码。                                                                                                                                                                                                                                                                                                                                              |
     | **保存密码**                    | 按“Enter”选择“是”并保存密码。 选择“否”，系统将在每次使用连接配置文件时提示输入密码。                                                                                                                                                                                                                                                                              |
     | “配置文件名称”（可选）          | 键入连接配置文件的名称，例如 localhost 配置文件。                                                                                                                                                                                                                                                                                                                 |

     > :balloon: 输入所有值并选择“Enter”后，Visual Studio Code 将创建连接配置文件并连接到 SQL Server。

  6. 在下方的状态栏中验证连接。

     ![连接状态](https://docs.microsoft.com/zh-cn/sql/visual-studio-code/media/sql-server-develop-use-vscode/vscode-connection-status.png?view=sql-server-ver15)

- #### **使用方法**

  > :zap: [参考文档](https://docs.microsoft.com/zh-cn/sql/visual-studio-code/sql-server-develop-use-vscode?view=sql-server-ver15#create-a-sql-database)
